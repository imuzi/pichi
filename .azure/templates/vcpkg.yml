parameters:
  toolchain: ''

steps:
  - task: Cache@2
    inputs:
      key: 'vcpkg | ${{ parameters.toolchain }} | $(PLATFORM)'
      path: $(VCPKG_INSTALLATION_ROOT)/installed
    displayName: "Cache VCPKG packages"
  - powershell: >
      (git -C "$(VCPKG_INSTALLATION_ROOT)" pull origin master) -Or ($True);
      (Get-Content C:\vcpkg\scripts\buildsystems\vcpkg.cmake).replace('set(Z_VCPKG_TARGET_TRIPLET_ARCH x64)', 'set(Z_VCPKG_TARGET_TRIPLET_ARCH x86)') | Set-Content C:\vcpkg\scripts\buildsystems\vcpkg.cmake;
      bootstrap-vcpkg.bat
    displayName: "Upgrade vcpkg"
  - powershell: (vcpkg install boost-system:$(PLATFORM)) -Or ($True)
    displayName: "Ignore installation error of boost-system"
  - powershell: |
      vcpkg install boost-asio:$(PLATFORM) boost-beast:$(PLATFORM) boost-coroutine2:$(PLATFORM) `
        boost-filesystem:$(PLATFORM) boost-mpl:$(PLATFORM) boost-program-options:$(PLATFORM) `
        boost-scope-exit:$(PLATFORM) boost-test:$(PLATFORM) libmaxminddb:$(PLATFORM) `
        libsodium:$(PLATFORM) mbedtls:$(PLATFORM) rapidjson:$(PLATFORM)
    displayName: "Prepare VCPKG packages"
